#修改TNAME: MI-R4A中的MI-R4A为你需要编译的型号，注意名称要与configs/templates/目录下的名字相同
name: Build MI-R4A Padavan4.4
on:
  workflow_dispatch:
    inputs:
      name:
        description: "Build Pure AP Padavan"
        required: true
        default: "build"
  # 注释其他触发器，避免自动运行

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
    - name: Checkout
      uses: actions/checkout@master

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        sudo apt-get -y install unzip libtool-bin curl cmake gperf gawk flex bison xxd fakeroot \
        cpio git python3-docutils gettext automake autopoint texinfo build-essential \
        pkg-config zlib1g-dev libgmp3-dev libmpc-dev libmpfr-dev libncurses5-dev libltdl-dev wget

    - name: Clone source code
      run: |
        git clone --depth=1 https://github.com/jinenge/padavan-4.4.git /opt/rt-n56u
        cd /opt/rt-n56u/toolchain-mipsel
        sh dl_toolchain.sh
        mkdir -p /opt/images/

    - name: Build Firmware (Pure AP Mode - Full Fix)
      env:
        TNAME: RT-N56U  # 完整修复：用仓库自带 RT-N56U 模板（兼容 R3GV2 MT7621，无 MI-R4A 问题）
      run: |
        cd /opt/rt-n56u/trunk
        # 检查 config
        if [ ! -f "configs/templates/$TNAME.config" ]; then
          echo "Error: configs/templates/$TNAME.config not found. Available: $(ls configs/templates/ | head -5)"
          exit 1
        fi
        cp -f configs/templates/$TNAME.config .config
        # 保留 OpenSSL（安全）
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=n/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y/g' .config
        # 移除所有插件（合并 sed，高效）
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_XRAY/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_V2RAY/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_TROJAN/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SSOBFS/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ADBYBY/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ADGUARDHOME/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SMARTDNS/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ZEROTIER/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ALIDDNS/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_DDNSTO/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_DDNSGO/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_WIREGUARD/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_CLOUDFLARE/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ALDRIVER/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_MENTOHUST/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_FTPD/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ALIST/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SQM/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_OC/d' .config
        sed -i '/CONFIG_FIRMWARE_MT7621_OC/d' .config
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_DNSFORWARDER=y/CONFIG_FIRMWARE_INCLUDE_DNSFORWARDER=n/g' .config
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_SCUTCLIENT=y/CONFIG_FIRMWARE_INCLUDE_SCUTCLIENT=n/g' .config
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_SRELAY=y/CONFIG_FIRMWARE_INCLUDE_SRELAY=n/g' .config
        # 纯净添加：所有 n
        echo "CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_XRAY=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_V2RAY=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_TROJAN=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_SSOBFS=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_ADBYBY=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_ADGUARDHOME=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_SMARTDNS=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_ZEROTIER=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_ALIDDNS=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_DDNSTO=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_DDNSGO=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_WIREGUARD=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_CLOUDFLARE=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_ALDRIVER=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_MENTOHUST=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_FTPD=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_ALIST=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_SQM=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_OC=n" >> .config
        # AP 核心 + 完整修复打包模块（生成 .bin）
        echo "CONFIG_FIRMWARE_INCLUDE_WIRELESS=y" >> .config  # WiFi 必需
        echo "CONFIG_FIRMWARE_INCLUDE_DNSMASQ=y" >> .config  # DHCP 桥接
        echo "CONFIG_FIRMWARE_INCLUDE_LUCI=y" >> .config  # 精简 Web
        echo "CONFIG_TARGET_ROOTFS_UBIFS=y" >> .config  # 修复：UBI FS（生成 images）
        echo "CONFIG_PACKAGE_squashfs=y" >> .config  # 修复：SquashFS 打包
        echo "CONFIG_FIRMWARE_INCLUDE_UBOOT=y" >> .config  # Boot 支持
        echo "CONFIG_TARGET_IMAGES=y" >> .config  # 修复：启用 images 输出
        # 调试：保存 config
        cp .config /opt/images/config_debug.txt
        echo "Config debug saved."
        sudo ./clear_tree
        sudo ./build_firmware_modify $TNAME 0
        # 检查/移动文件
        if ls images/*.bin images/*.trx 1> /dev/null 2>&1; then
          sudo mv -f images/*.bin images/*.trx /opt/images/
          echo "Files moved successfully: $(ls /opt/images/*.bin /opt/images/*.trx 2>/dev/null || echo 'None')"
        else
          echo "Warning: No .bin/.trx in images/. Check make output."
        fi
        cd /opt/images/
        ls -la *.bin *.trx 2>/dev/null || echo "No output files."
        md5sum *.bin *.trx > checksum.md5 2>/dev/null || echo "No checksum."

    - name: Upload packages
      uses: actions/upload-artifact@master
      if: always()
      with:
        name: Padavan-RT-N56U-Pure-AP-Full
        path: /opt/images/
